<!DOCTYPE html>
<html>
  <head>
    <title>Measuring smoothness</title>
    <style>
      img {
        position: fixed;
        left: 0px;
        top: 0px;
      }
      #item1 > * {
        vertical-align: middle;
      }

      #item2 {
        position: fixed;
        left: 250px;
        top: 70px;
      }

    </style>
  </head>
  <body style="-webkit-transform:translateZ(0)">
    <img id="foo" src="chrome-logo.png" width="250">
    <div id="item2">
      <div style="width: 400px">
      Intervals between frames, using requestAnimationFrame and window.performance.webkitNow():
      </div>
      <canvas id="canvas" width="400px" height="120px"></canvas>
    </div>
    <script>
      el = document.querySelector("img");
      var rotation = 0;
      var running = false;

      function rotate() {
        rotation += 180;
        el.style.webkitTransform = "rotate(" + rotation + "deg)";
      }
      el.addEventListener("webkitTransitionEnd", function() {
        if (running)
          rotate();
      });

      var intervals = [];
      for (var i = 0; i < 180; i++) {
        intervals.push(0);
      }

      function redraw(canvas, intervals) {
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,400,120);
        ctx.beginPath();
        var i33 = 1000 / 15.0;

        var h = canvas.height;
        ctx.strokeStyle = 'black';
        ctx.beginPath();

        var y = h - ((intervals[0] - 0) / i33) * h;
        ctx.moveTo(0, y);
        for (var i = 1; i < intervals.length; i++) {
          if (!intervals[i])
            continue;
          var y = h - ((intervals[i] - 0) / i33) * h;
          ctx.lineTo(2*i, y);
        }
        ctx.stroke();

        var y16 = h - (((1000 / 60) - 0) / i33) * h;
        ctx.strokeStyle = 'blue';
        ctx.beginPath();
        ctx.moveTo(0,y16);
        ctx.lineTo(400,y16);
        ctx.stroke();


        var y30 = h - (((1000 / 30) - 0) / i33) * h;
        ctx.strokeStyle = 'red';
        ctx.beginPath();
        ctx.moveTo(0,y30);
        ctx.lineTo(400,y30);
        ctx.stroke();

        ctx.fillStyle = 'black';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'bottom';
        ctx.fillText('16.6ms', 400, y16);
        ctx.fillText('33.3ms', 400, y30);

      }
      var numFrames = 0;
      var lastTimestamp;
      function tick() {
        var now;
        if (window.performance.webkitNow)
          now = window.performance.webkitNow();
        else
          now = Date.now();

        if (lastTimestamp) {
          var i = (numFrames++) % intervals.length;
          intervals[i] = now - lastTimestamp;

          var canvas2 = document.querySelector('#canvas');
          redraw(canvas2, intervals);
        }

        lastTimestamp = now;
        if (running)
          webkitRequestAnimationFrame(tick, document.querySelector('img'));
      }

      function start() {
        running = true;
        rotate();
        webkitRequestAnimationFrame(tick, document.querySelector('img'));
      }
      document.querySelector('img').addEventListener('click', function() {
        setTimeout(function() { running = false; }, 30000);
        start();
      });

      // start rotating
      el.style.webkitTransition = "all 2s linear";
      el.style.webkitTransform = "rotate(180deg)";
      rotate();
    </script>
  </body>
</html>
